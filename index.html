<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>人事課 窓口予約 入口</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <!-- GIS ライブラリ -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body{
      font-family:"Noto Sans JP",-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f5f5f7; color:#111827;
      min-height:100vh; margin:0;
      display:flex; align-items:center; justify-content:center;
      padding:24px 16px;
    }
    .card{
      max-width:480px; width:100%;
      background:#fff; border-radius:8px;
      border:1px solid #e5e7eb;
      padding:20px 18px 18px;
    }
    h1{ font-size:20px; margin:0 0 8px; font-weight:700; }
    p{ font-size:14px; margin:4px 0; color:#4b5563; }
    .domain{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      padding:1px 4px; border-radius:4px;
      background:#f3f4f6; border:1px solid #e5e7eb;
    }
    #gsiArea{ margin-top:16px; display:flex; justify-content:center; }
    .note{ margin-top:10px; font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <main class="card">
    <h1>人事課 窓口予約システム 入口</h1>
    <p>
      このシステムは <span class="domain">@katsura.com</span> の Google アカウントでのみ利用できます。<br>
      下のボタンから桂病院アカウントでログインし、予約画面へ進んでください。
    </p>

    <div id="gsiArea">
      <div id="gsiButton"></div>
    </div>

    <p class="note">
      ※ 個人の @gmail.com などでログインすると、次の画面で「権限がありません」と表示されます。<br>
      その場合は、ブラウザ右上のアイコンから <span class="domain">@katsura.com</span> アカウントに切り替えてください。
    </p>
  </main>

  <script>
    // ★ 実際の値に置き換え ★
    const GIS_CLIENT_ID = '306425813118-enl6g9d24jg0c68tuvp11jc4glr0efs0.apps.googleusercontent.com';
    const REDIRECT_URL  = 'https://script.google.com/a/macros/katsura.com/s/AKfycbytgABHu-l_GiaqZJHy0G87Kpr9JEFY0rXlmylS_wEW2T5QiFX1wl2gb0a68fCqmCKV/exec'; // Apps Script WebApp の URL
    const ALLOWED_DOMAIN = 'katsura.com';

    // IDトークンをデコードして payload を取り出す簡易ヘルパ
    function decodeJwt(token){
      try{
        const payload = token.split('.')[1]
          .replace(/-/g, '+').replace(/_/g, '/');
        return JSON.parse(atob(payload));
      }catch(e){
        console.error('decode error', e);
        return {};
      }
    }

    function handleCredentialResponse(res){
      const token = res.credential;
      const payload = decodeJwt(token);
      const email = payload.email || '';
      const hd    = (payload.hd || '').toLowerCase();

      console.log('GIS payload:', payload);

      // hd でドメインをざっくりチェック（本当の制限は WebApp 側で実施）
      if (hd !== ALLOWED_DOMAIN) {
        alert('katsura.com の職員アカウントでログインしてください。\n現在のアカウント: ' + (email || '不明'));
        return;
      }

      // OKなら予約WebAppへ遷移
      window.location.href = REDIRECT_URL;
    }

    window.onload = function(){
      if (!window.google || !window.google.accounts || !window.google.accounts.id) {
        console.error('Google Identity Services が読み込まれていません');
        return;
      }

      google.accounts.id.initialize({
        client_id: GIS_CLIENT_ID,
        callback: handleCredentialResponse,
        hd: ALLOWED_DOMAIN,      // UI上は katsura.com を優先表示させるヒント
        auto_select: false,
        itp_support: true
      });

      google.accounts.id.renderButton(
        document.getElementById('gsiButton'),
        {
          type: 'standard',
          theme: 'outline',
          text: 'continue_with',
          size: 'large',
          logo_alignment: 'left'
        }
      );

      // One Tap は今回はオフにしておく
      // google.accounts.id.prompt();
    };
  </script>
</body>
</html>
